if(!window.EWModalbox){var EWModalbox=new Object()}EWModalbox.Methods={focusableElements:new Array,currFocused:0,initialized:false,active:true,pExecutor:0,options:{positionType:"absolute",title:"&nbsp;",width:500,height:90,overlay:true,maxTop:0,overlayClose:true,overlayOpacity:0.65,overlayDuration:0.25,slideDownDuration:0.5,slideUpDuration:0.5,resizeDuration:0.25,inactiveFade:true,transitions:true,loadingString:"Please wait. Loading...",closeString:"Close window",closeValue:"&times;",params:{},method:"get",autoFocusing:true},_options:new Object,setOptions:function(options){Object.extend(this.options,options||{})},_init:function(options){Object.extend(this._options,this.options);this.setOptions(options);this.MBoverlay=new Element("div",{id:"EWMOverlay",opacity:"0"});if(!this.options.overlay){$(this.MBoverlay).setStyle({display:"none"})}var style="position: fixed!important; display:none;";if(this.options.positionType=="absolute"){style="position: absolute!important; display:none;"}this.MBwindow=new Element("div",{id:"EWMWindow",style:style}).update(this.MBframe=new Element("div",{id:"EWMFrame"}).update(this.EWMHeader=new Element("div",{id:"EWMHeader"}).update(this.MBcaption=new Element("div",{id:"EWMCaption"}))));this.MBclose=new Element("a",{id:"EWMClose",title:this.options.closeString,href:"#"}).update("<span>"+this.options.closeValue+"</span>");this.EWMHeader.insert({bottom:this.MBclose});this.MBcontent=new Element("div",{id:"EWMContent"}).update(this.MBloading=new Element("div",{id:"EWMLoading"}).update(this.options.loadingString));this.MBframe.insert({bottom:this.MBcontent});var injectToEl=$(document.body);injectToEl.insert({bottom:this.MBwindow});injectToEl.insert({bottom:this.MBoverlay});this.initScrollX=window.pageXOffset||document.body.scrollLeft||document.documentElement.scrollLeft;this.initScrollY=window.pageYOffset||document.body.scrollTop||document.documentElement.scrollTop;this.hideObserver=this._hide.bindAsEventListener(this);this.kbdObserver=this._kbdHandler.bindAsEventListener(this);this._initObservers();this.initialized=true;this.center()},show:function(content,options){if(this._p){this._p.stop()}if(!this.initialized){this._init(options)}this.content=content;this.setOptions(options);if(this.options.title){$(this.MBcaption).update(this.options.title)}if(this.MBwindow.style.display=="none"){this._appear();this.event("onShow")}else{this._update();this.resizeModal();this.event("onUpdate")}},hide:function(s,options){if(this._p){this._p.stop()}if(s>0){this._p=new PeriodicalExecuter(function(p){p.stop();this.hide(0,options)}.bind(this),s)}else{if(this.pExecutor){this.pExecutor.stop();this.pExecutor=0}if(this.initialized){if(options&&typeof options.element!="function"){Object.extend(this.options,options)}this.event("beforeHide");if(this.options.transitions){Effect.SlideUp(this.MBwindow,{duration:this.options.slideUpDuration,transition:Effect.Transitions.sinoidal,afterFinish:this._deinit.bind(this)})}else{$(this.MBwindow).hide();this._deinit()}}}},_hide:function(event){event.stop();if(event.element().id=="EWMOverlay"&&!this.options.overlayClose){return false}this.hide()},_appear:function(){if(Prototype.Browser.IE&&Prototype.BrowserFeatures.Version<7){window.scrollTo(0,0);this._prepareIE("100%","hidden")}this._setWidth();this._setPosition();if(this.options.transitions){$(this.MBoverlay).setStyle({opacity:0});new Effect.Fade(this.MBoverlay,{from:0,to:this.options.overlayOpacity,duration:this.options.overlayDuration,afterFinish:function(){new Effect.SlideDown(this.MBwindow,{duration:this.options.slideDownDuration,transition:Effect.Transitions.sinoidal,afterFinish:function(){this._setPosition();this.loadContent()}.bind(this)})}.bind(this)})}else{$(this.MBoverlay).setStyle({opacity:this.options.overlayOpacity});$(this.MBwindow).show();this._setPosition();this.loadContent()}this._setWidthAndPosition=this._setWidthAndPosition.bindAsEventListener(this);Event.observe(window,"resize",this._setWidthAndPosition)},resizeModal:function(options){if(!options){options={}}options.oheight=$(this.MBcontent).getHeight();options.ohheight=$(this.EWMHeader).getHeight();options.owidth=$(this.MBwindow).getWidth();this.MBcontent.setStyle({height:""});EWModalbox.resize((this.options.width-$(this.MBwindow).getWidth()),$(this.MBcontent).getHeight()-$(this.MBwindow).getHeight()+$(this.EWMHeader).getHeight(),options);this.center()},resize:function(byWidth,byHeight,options){var b=document.viewport.getDimensions();var oWidth=$(this.MBoverlay).getWidth();var wHeight=$(this.MBwindow).getHeight();var wWidth=$(this.MBwindow).getWidth();var hHeight=$(this.EWMHeader).getHeight();var cHeight=$(this.MBcontent).getHeight();var newHeight=((wHeight-hHeight+byHeight)<cHeight)?(cHeight+hHeight):(wHeight+byHeight);if(newHeight>b.height){newHeight=b.height-5}var newWidth=wWidth+byWidth;if(options){this.setOptions(options)}this.MBwindow.setStyle({width:newWidth+"px",height:newHeight+"px"});setTimeout(function(){this.event("_afterResize");this.event("afterResize");
this.MBcontent.setStyle({height:($(this.MBframe).getHeight()-hHeight-13)+"px",overflow:"auto"})}.bind(this),1);if(wHeight==newHeight&&wWidth==newWidth){if(this.pExecutor){this.pExecutor.stop()}}else{if(!this.pExecutor){this.pExecutor=new PeriodicalExecuter(function(pe){this.resizeModal()}.bind(this),0.25)}}},center:function(){var b=document.viewport.getDimensions();var tAdjustment=0;if(this.options.positionType=="absolute"){tAdjustment=document.viewport.getScrollOffsets().top}var d=parseInt((b.height-$(this.MBwindow).getHeight())/2);if(d>this.options.maxTop){d=this.options.maxTop}var top=0;if(d>0){top=d}top+=tAdjustment;this.MBwindow.setStyle({top:top+"px"})},_update:function(){this.MBcontent.setStyle({height:"auto"});$(this.MBcontent).update($(this.MBloading).update(this.options.loadingString));this.loadContent()},loadContent:function(){if(this.event("beforeLoad")!=false){if(typeof this.content=="string"){var htmlRegExp=new RegExp(/<\/?[^>]+>/gi);if(htmlRegExp.test(this.content)){this._insertContent(this.content.stripScripts(),function(){this.content.extractScripts().map(function(script){try{(window.execScript)?window.execScript(script):window.setTimeout(script,0)}catch(e){}}.bind(window))}.bind(this))}else{new Ajax.Request(this.content,{method:this.options.method.toLowerCase(),parameters:this.options.params,onSuccess:function(transport){var response=new String(transport.responseText);this._insertContent(transport.responseText.stripScripts(),function(){response.extractScripts().map(function(script){try{(window.execScript)?window.execScript(script):window.setTimeout(script,0)}catch(e){}}.bind(window))}.bind(this))}.bind(this),onException:function(instance,exception){EWModalbox.hide();throw ("EWModalbox Loading Error: "+exception)}})}}else{if(typeof this.content=="object"){}else{EWModalbox.hide()}}}},_insertContent:function(content,callback){$(this.MBcontent).hide().update("");if(typeof content=="string"){this.MBcontent.update(new Element("div",{style:"display: none"}).update(content)).down().show()}else{if(typeof content=="object"){var _htmlObj=content.cloneNode(true);if(content.id){content.id="MB_"+content.id}$(content).select("*[id]").each(function(el){el.id="MB_"+el.id});this.MBcontent.update(_htmlObj).down("div").show();if(Prototype.Browser.IE){$$("#EWMContent select").invoke("setStyle",{visibility:""})}}}setTimeout(function(){this._putContent(callback)}.bind(this),1)},_putContent:function(callback){this.MBcontent.show();this.resizeModal();this.focusableElements=this._findFocusableElements();this._setFocus();if(callback!=undefined){callback()}this.event("afterLoad")},_initObservers:function(){$(this.MBclose).observe("click",this.hideObserver);if(this.options.overlayClose){$(this.MBoverlay).observe("click",this.hideObserver)}if(Prototype.Browser.Gecko){Event.observe(document,"keypress",this.kbdObserver)}else{Event.observe(document,"keydown",this.kbdObserver)}},_removeObservers:function(){$(this.MBclose).stopObserving("click",this.hideObserver);if(this.options.overlayClose){$(this.MBoverlay).stopObserving("click",this.hideObserver)}if(Prototype.Browser.Gecko){Event.stopObserving(document,"keypress",this.kbdObserver)}else{Event.stopObserving(document,"keydown",this.kbdObserver)}},_setFocus:function(){if(this.focusableElements.length>0&&this.options.autoFocusing==true){var firstEl=this.focusableElements.find(function(el){return el.tabIndex==1})||this.focusableElements.first();this.currFocused=this.focusableElements.toArray().indexOf(firstEl);firstEl.focus()}else{if($(this.MBclose).visible()){$(this.MBclose).focus()}}},_findFocusableElements:function(){this.MBcontent.select("input:not([type~=hidden]), select, textarea, button, a[href]").invoke("addClassName","MB_focusable");return this.MBcontent.select(".MB_focusable")},_kbdHandler:function(event){var node=event.element();switch(event.keyCode){case Event.KEY_TAB:event.stop();if(node!=this.focusableElements[this.currFocused]){this.currFocused=this.focusableElements.toArray().indexOf(node)}if(!event.shiftKey){if(this.currFocused==this.focusableElements.length-1){this.focusableElements.first().focus();this.currFocused=0}else{this.currFocused++;this.focusableElements[this.currFocused].focus()}}else{if(this.currFocused==0){this.focusableElements.last().focus();this.currFocused=this.focusableElements.length-1}else{this.currFocused--;this.focusableElements[this.currFocused].focus()}}break;case Event.KEY_ESC:if(this.active){this._hide(event)}break;case 32:this._preventScroll(event);break;case 0:if(event.which==32){this._preventScroll(event)}break;case Event.KEY_UP:case Event.KEY_DOWN:case Event.KEY_PAGEDOWN:case Event.KEY_PAGEUP:case Event.KEY_HOME:case Event.KEY_END:if(Prototype.Browser.WebKit&&!["textarea","select"].include(node.tagName.toLowerCase())){event.stop()}else{if((node.tagName.toLowerCase()=="input"&&["submit","button"].include(node.type))||(node.tagName.toLowerCase()=="a")){event.stop()}}break}},_preventScroll:function(event){if(!["input","textarea","select","button"].include(event.element().tagName.toLowerCase())){event.stop()
}},_deinit:function(){this._removeObservers();Event.stopObserving(window,"resize",this._setWidthAndPosition);if(this.options.transitions&&this.options.overlay){Effect.toggle(this.MBoverlay,"appear",{duration:this.options.overlayDuration,afterFinish:this._removeElements.bind(this)})}else{this.MBoverlay.hide();this._removeElements()}$(this.MBcontent).setStyle({overflow:"",height:""})},_removeElements:function(){$(this.MBoverlay).remove();$(this.MBwindow).remove();if(Prototype.Browser.IE&&!navigator.appVersion.match(/\b7.0\b/)){this._prepareIE("","");window.scrollTo(this.initScrollX,this.initScrollY)}if(typeof this.content=="object"){if(this.content.id&&this.content.id.match(/MB_/)){this.content.id=this.content.id.replace(/MB_/,"")}this.content.select("*[id]").each(function(el){el.id=el.id.replace(/MB_/,"")})}this.initialized=false;this.event("afterHide");this.setOptions(this._options)},_setWidth:function(){$(this.MBwindow).setStyle({width:this.options.width+"px",height:this.options.height+"px"})},_setPosition:function(){$(this.MBwindow).setStyle({left:(($(this.MBoverlay).getWidth()-$(this.MBwindow).getWidth())/2)+"px"})},_setWidthAndPosition:function(){$(this.MBwindow).setStyle({width:this.options.width+"px"});this._setPosition();this.resizeModal()},_getScrollTop:function(){var theTop;if(document.documentElement&&document.documentElement.scrollTop){theTop=document.documentElement.scrollTop}else{if(document.body){theTop=document.body.scrollTop}}return theTop},_prepareIE:function(height,overflow){$$("html, body").invoke("setStyle",{width:height,height:height,overflow:overflow});$$("select").invoke("setStyle",{visibility:overflow})},event:function(eventName){if(this.options[eventName]){var returnValue=this.options[eventName]();this.options[eventName]=null;if(returnValue!=undefined){return returnValue}else{return true}}return true}};Object.extend(EWModalbox,EWModalbox.Methods);